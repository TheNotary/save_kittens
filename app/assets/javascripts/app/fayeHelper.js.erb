window.APP.fayeHelper = {
  initFayeClient: function() {
    var port = location.protocol == "http:" ? "8000" : "8001"
    var url = location.protocol + "//" + document.domain + ":" + port + "/faye"; // eg 'http://localhost:8000/faye'
    var fayeClient = new Faye.Client(url).on('transport:up', function() {
      // the client is online, disable polling...
      APP.fayeClient.online = true;
      APP.intervals.ClearAll();
    });
    fayeClient.subscriptions = [];

    window.APP.fayeClient = fayeClient;
  },
  subscriptions: {
    clearAll: function(){
      throw "not implemented";
    },
    add: function(channel, messageProcessingCallback){
      if ( !APP.fayeHelper.subscriptions.doesSubscriptionAlreadyExist(channel) ){
        var subscription = APP.fayeClient.subscribe(channel, function(message) {
          // message: {"signatureCount":54,"topThreeStates":["CA"]}
          messageProcessingCallback(message)
        });

        APP.fayeHelper.subscriptions.collection.push(subscription);
        return subscription;
      }
    },
    doesSubscriptionAlreadyExist: function(channel){
      for (subscription in APP.fayeHelper.subscriptions.collection){
        if (subscription._channels == channel)
          return true;
      return false;
      }
    },
    collection: []
  }
};

APP.fayeHelper.initFayeClient();
